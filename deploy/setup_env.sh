#!/bin/bash

# CyberCTF Arena - Environment Setup Script
set -e

echo "âš™ï¸  ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ CyberCTF Arena..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð²
if [ "$EUID" -ne 0 ]; then
    echo "âŒ ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ root: sudo ./setup_env.sh"
    exit 1
fi

PROJECT_DIR="/opt/ctf-arena"
ENV_FILE="$PROJECT_DIR/.env"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» ÐµÑÐ»Ð¸ Ð¾Ð½ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
if [ ! -f "$ENV_FILE" ]; then
    echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° .env..."
    
    # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ð¹ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡
    SECRET_KEY=$(openssl rand -hex 32)
    
    cat > "$ENV_FILE" << EOF
# CyberCTF Arena Environment Configuration
# Generated automatically - review and modify as needed

# Application Settings
APP_NAME=CyberCTF Arena
APP_VERSION=1.0.0
DEBUG=False

# Database Configuration
DATABASE_URL=postgresql://ctfuser:ctfpassword@localhost:5432/ctfarena

# JWT Security - CHANGE THIS IN PRODUCTION!
SECRET_KEY=$SECRET_KEY
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# CORS Origins
CORS_ORIGINS=["http://localhost:3000", "http://127.0.0.1:3000", "http://localhost:8000"]

# Email Configuration (optional)
# SMTP_SERVER=smtp.gmail.com
# SMTP_PORT=587
# SMTP_USERNAME=your-email@gmail.com
# SMTP_PASSWORD=your-app-password

# Telegram Bot (optional)
# TELEGRAM_BOT_TOKEN=your-telegram-bot-token
# TELEGRAM_CHAT_ID=your-chat-id

# Redis Configuration
REDIS_URL=redis://localhost:6379/0

# File Uploads
UPLOAD_DIR=uploads
MAX_FILE_SIZE=10485760

# Competition Settings
COMPETITION_START_TIME=2024-09-25T00:00:00
COMPETITION_END_TIME=2024-09-27T23:59:59
MAX_TEAM_SIZE=5

# Logging
LOG_LEVEL=INFO
LOG_FILE=/opt/ctf-arena/logs/ctf-arena.log
EOF

    echo "âœ… Ð¤Ð°Ð¹Ð» .env ÑÐ¾Ð·Ð´Ð°Ð½: $ENV_FILE"
    
    # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð°
    chown ctfapp:ctfapp "$ENV_FILE"
    chmod 600 "$ENV_FILE"
    
    echo ""
    echo "âš ï¸  Ð’ÐÐ–ÐÐž: ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» .env Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ:"
    echo "   sudo nano $ENV_FILE"
    echo ""
    echo "ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸:"
    echo "   - DATABASE_URL (ÐµÑÐ»Ð¸ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð°ÐµÑ‚ÑÑ Ð¾Ñ‚ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¾Ð¹)"
    echo "   - SECRET_KEY (ÑƒÐ¶Ðµ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½)"
    echo ""
    echo "ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸:"
    echo "   - Email (Ð´Ð»Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹)"
    echo "   - Telegram (Ð´Ð»Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹)"
    echo "   - CORS_ORIGINS (Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð°)"
    
else
    echo "âœ… Ð¤Ð°Ð¹Ð» .env ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚: $ENV_FILE"
    echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÐµÐ³Ð¾ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð¸ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ."
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
mkdir -p "$PROJECT_DIR/logs"
chown ctfapp:ctfapp "$PROJECT_DIR/logs"
chmod 755 "$PROJECT_DIR/logs"

echo ""
echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
