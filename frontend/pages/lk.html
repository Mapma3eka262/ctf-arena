<!-- frontend/pages/lk.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberCTF Arena - Вход в систему</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="/assets/css/animations.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        
        body {
            font-family: 'Share Tech Mono', monospace;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .auth-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            border-color: #EA000F;
            box-shadow: 0 0 0 2px rgba(234, 0, 15, 0.2);
        }
        
        .tab-button {
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: #EA000F;
            color: white;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center py-12 px-4">
    <div class="w-full max-w-md">
        <!-- Logo -->
        <div class="text-center mb-8">
            <div class="inline-block mb-4">
                <div class="w-16 h-16 bg-red-600 rounded-2xl flex items-center justify-center mx-auto">
                    <span class="text-white font-bold text-xl">CTF</span>
                </div>
            </div>
            <h1 class="text-4xl font-bold">
                <span class="text-white">Cyber</span>
                <span class="text-red-600">CTF</span>
            </h1>
            <p class="text-gray-400 mt-2">Вход в систему</p>
        </div>

        <!-- Auth Tabs -->
        <div class="flex bg-gray-800 rounded-lg p-1 mb-6">
            <button id="login-tab" class="tab-button flex-1 py-2 px-4 rounded-md font-medium active">
                Вход
            </button>
            <button id="register-tab" class="tab-button flex-1 py-2 px-4 rounded-md font-medium text-gray-400">
                Регистрация
            </button>
        </div>

        <!-- Login Form -->
        <div id="login-form" class="auth-container rounded-2xl p-8 fade-in">
            <form id="loginForm">
                <div class="space-y-4">
                    <div>
                        <label for="login-username" class="block text-sm font-medium text-gray-300 mb-2">
                            Логин или Email
                        </label>
                        <input 
                            type="text" 
                            id="login-username"
                            name="username"
                            class="form-input w-full px-4 py-3 rounded-lg text-white placeholder-gray-500"
                            placeholder="Введите ваш логин или email"
                            required
                        >
                    </div>
                    
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-300 mb-2">
                            Пароль
                        </label>
                        <input 
                            type="password" 
                            id="login-password"
                            name="password"
                            class="form-input w-full px-4 py-3 rounded-lg text-white placeholder-gray-500"
                            placeholder="Введите ваш пароль"
                            required
                        >
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <label class="flex items-center">
                            <input type="checkbox" class="rounded bg-gray-700 border-gray-600 text-red-600 focus:ring-red-600">
                            <span class="ml-2 text-sm text-gray-300">Запомнить меня</span>
                        </label>
                        <a href="#" class="text-sm text-red-500 hover:text-red-400 transition-colors">
                            Забыли пароль?
                        </a>
                    </div>
                    
                    <button 
                        type="submit"
                        class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-bold transition-colors duration-300"
                    >
                        Войти в систему
                    </button>
                </div>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-gray-400">
                    Нет аккаунта? 
                    <a href="#" id="switch-to-register" class="text-red-500 hover:text-red-400 transition-colors">
                        Зарегистрируйтесь
                    </a>
                </p>
            </div>
        </div>

        <!-- Register Form -->
        <div id="register-form" class="auth-container rounded-2xl p-8 hidden">
            <form id="registerForm">
                <div class="space-y-4">
                    <div>
                        <label for="register-username" class="block text-sm font-medium text-gray-300 mb-2">
                            Логин
                        </label>
                        <input 
                            type="text" 
                            id="register-username"
                            name="username"
                            class="form-input w-full px-4 py-3 rounded-lg text-white placeholder-gray-500"
                            placeholder="Придумайте логин"
                            required
                        >
                        <p class="text-xs text-gray-500 mt-1">Только буквы, цифры и подчеркивания</p>
                    </div>
                    
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-300 mb-2">
                            Email
                        </label>
                        <input 
                            type="email" 
                            id="register-email"
                            name="email"
                            class="form-input w-full px-4 py-3 rounded-lg text-white placeholder-gray-500"
                            placeholder="Введите ваш email"
                            required
                        >
                    </div>
                    
                    <div>
                        <label for="register-team" class="block text-sm font-medium text-gray-300 mb-2">
                            Название команды
                        </label>
                        <input 
                            type="text" 
                            id="register-team"
                            name="team_name"
                            class="form-input w-full px-4 py-3 rounded-lg text-white placeholder-gray-500"
                            placeholder="Придумайте название команды"
                            required
                        >
                    </div>
                    
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-300 mb-2">
                            Пароль
                        </label>
                        <input 
                            type="password" 
                            id="register-password"
                            name="password"
                            class="form-input w-full px-4 py-3 rounded-lg text-white placeholder-gray-500"
                            placeholder="Придумайте пароль"
                            required
                        >
                        <p class="text-xs text-gray-500 mt-1">Минимум 6 символов, включая цифры и буквы</p>
                    </div>
                    
                    <div>
                        <label for="register-password-confirm" class="block text-sm font-medium text-gray-300 mb-2">
                            Подтверждение пароля
                        </label>
                        <input 
                            type="password" 
                            id="register-password-confirm"
                            name="password_confirm"
                            class="form-input w-full px-4 py-3 rounded-lg text-white placeholder-gray-500"
                            placeholder="Повторите пароль"
                            required
                        >
                    </div>
                    
                    <div class="flex items-center">
                        <input 
                            type="checkbox" 
                            id="register-terms"
                            class="rounded bg-gray-700 border-gray-600 text-red-600 focus:ring-red-600"
                            required
                        >
                        <label for="register-terms" class="ml-2 text-sm text-gray-300">
                            Я согласен с 
                            <a href="#" class="text-red-500 hover:text-red-400 transition-colors">
                                условиями использования
                            </a>
                        </label>
                    </div>
                    
                    <button 
                        type="submit"
                        class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-bold transition-colors duration-300"
                    >
                        Создать аккаунт
                    </button>
                </div>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-gray-400">
                    Уже есть аккаунт? 
                    <a href="#" id="switch-to-login" class="text-red-500 hover:text-red-400 transition-colors">
                        Войдите
                    </a>
                </p>
            </div>
        </div>

        <!-- Demo Notice -->
        <div class="mt-8 p-4 bg-yellow-600 bg-opacity-20 border border-yellow-600 rounded-lg text-center">
            <p class="text-yellow-400 text-sm">
                <strong>Демо доступ:</strong> admin / admin123
            </p>
        </div>
    </div>

    <script>
        // Tab Switching
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const switchToRegister = document.getElementById('switch-to-register');
        const switchToLogin = document.getElementById('switch-to-login');

        function showLoginForm() {
            loginTab.classList.add('active');
            loginTab.classList.remove('text-gray-400');
            registerTab.classList.remove('active');
            registerTab.classList.add('text-gray-400');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
        }

        function showRegisterForm() {
            registerTab.classList.add('active');
            registerTab.classList.remove('text-gray-400');
            loginTab.classList.remove('active');
            loginTab.classList.add('text-gray-400');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
        }

        loginTab.addEventListener('click', showLoginForm);
        registerTab.addEventListener('click', showRegisterForm);
        switchToRegister.addEventListener('click', (e) => {
            e.preventDefault();
            showRegisterForm();
        });
        switchToLogin.addEventListener('click', (e) => {
            e.preventDefault();
            showLoginForm();
        });

        // Form Handling
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                username: formData.get('username'),
                password: formData.get('password')
            };

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'username': data.username,
                        'password': data.password
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Сохраняем токен
                    localStorage.setItem('authToken', result.access_token);
                    
                    // Показываем уведомление об успехе
                    if (window.showNotification) {
                        window.showNotification('Вход выполнен успешно!', 'success');
                    }
                    
                    // Перенаправляем на главную страницу
                    setTimeout(() => {
                        window.location.href = '/pages/arena.html';
                    }, 1000);
                    
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Ошибка входа');
                }
            } catch (error) {
                console.error('Login error:', error);
                if (window.showNotification) {
                    window.showNotification(error.message || 'Ошибка входа', 'error');
                }
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                username: formData.get('username'),
                email: formData.get('email'),
                password: formData.get('password'),
                password_confirm: formData.get('password_confirm'),
                team_name: formData.get('team_name')
            };

            // Базовая валидация на клиенте
            if (data.password !== data.password_confirm) {
                if (window.showNotification) {
                    window.showNotification('Пароли не совпадают', 'error');
                }
                return;
            }

            if (data.password.length < 6) {
                if (window.showNotification) {
                    window.showNotification('Пароль должен содержать минимум 6 символов', 'error');
                }
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    if (window.showNotification) {
                        window.showNotification('Регистрация успешна! Теперь вы можете войти.', 'success');
                    }
                    
                    // Переключаемся на форму входа
                    showLoginForm();
                    
                    // Заполняем логин
                    document.getElementById('login-username').value = data.username;
                    
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Ошибка регистрации');
                }
            } catch (error) {
                console.error('Registration error:', error);
                if (window.showNotification) {
                    window.showNotification(error.message || 'Ошибка регистрации', 'error');
                }
            }
        });

        // Demo Login
        function fillDemoCredentials() {
            document.getElementById('login-username').value = 'admin';
            document.getElementById('login-password').value = 'admin123';
            
            if (window.showNotification) {
                window.showNotification('Демо данные заполнены. Нажмите "Войти в систему"', 'info');
            }
        }

        // Автозаполнение демо данных при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            // Заполняем демо данные через 1 секунду после загрузки
            setTimeout(fillDemoCredentials, 1000);
            
            // Инициализация Feather icons
            feather.replace();
        });

        // Redirect if already authenticated
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('authToken');
            if (token) {
                // Проверяем валидность токена
                fetch('/api/users/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                }).then(response => {
                    if (response.ok) {
                        // Пользователь уже аутентифицирован, перенаправляем
                        window.location.href = '/pages/arena.html';
                    }
                }).catch(() => {
                    // Токен невалиден, очищаем
                    localStorage.removeItem('authToken');
                });
            }
        });
    </script>
</body>
</html>